<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Caretaker Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Leaflet Map -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

h1 { color: #38bdf8; text-align:center; }

.card {
  background:#020617;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
  border-left:6px solid #22c55e;
}

.alert { border-left-color:#ef4444; }
.warning { border-left-color:#facc15; }

button {
  padding:8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.btn-add { background:#38bdf8; }
.btn-edit { background:#facc15; }
.btn-del { background:#ef4444; }
.btn-save { background:#22c55e; }

input {
  width:100%;
  padding:8px;
  margin-bottom:8px;
  border-radius:6px;
  border:none;
}

#map {
  height:300px;
  border-radius:12px;
  margin-top:10px;
}
.hidden { display:none; }
.alert-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 320px;
  max-height: 80vh;
  overflow-y: auto;
  background: #020617;
  border-left: 6px solid #ef4444;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 0 20px rgba(239,68,68,0.4);
  z-index: 999;
}

.alert-panel.hidden {
  display: none;
}

.alert-item {
  background: #0f172a;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 10px;
}

.alert-item h4 {
  margin: 0 0 6px;
  color: #ef4444;
}

.alert-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.alert-actions button {
  flex: 1;
  padding: 6px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 12px;
}

.btn-ok { background: #22c55e; }
.btn-bad { background: #ef4444; }

</style>
</head>

<body>

<h1>üßë‚Äç‚öïÔ∏è Caretaker Dashboard</h1>

<button class="btn-add" onclick="openForm()">‚ûï Add Patient</button>
<br><br>

<div id="patients"></div>

<!-- PATIENT FORM -->
<div id="formBox" class="card hidden">
  <h3 id="formTitle">Add Patient</h3>

  <input id="pid" placeholder="Patient ID (unique)" />
  <input id="pname" placeholder="Name" />
  <input id="page" placeholder="Age" />
  <input id="pcondition" placeholder="Condition" />

  <button class="btn-save" onclick="savePatient()">üíæ Save</button>
  <button onclick="closeForm()">Cancel</button>
</div>

<!-- SAFE CENTER MAP -->
<div id="mapBox" class="card hidden">
  <h3>üìç Set Safe Center (Click on Map)</h3>
  <div id="map"></div>
  <button class="btn-save" onclick="saveSafeCenter()">Save Safe Center</button>
  <button onclick="closeMap()">Cancel</button>
</div>

<!-- üö® ALERT BAR -->
<div id="alertPanel" class="alert-panel hidden">
  <h3>üö® Active Alerts</h3>
  <div id="alertList"></div>
</div>


<script>
/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAoR0vhcrxB3nw39ncqLJfmMET7ufokn1A",
  authDomain: "ai-wandering-system.firebaseapp.com",
  databaseURL: "https://ai-wandering-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ai-wandering-system",
  storageBucket: "ai-wandering-system.firebasestorage.app",
  messagingSenderId: "443603981661",
  appId: "1:443603981661:web:ce8ce7697cfbed2327c4b4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- PATIENT LIST ---------------- */
db.ref("patients").on("value", snap => {
  const container = document.getElementById("patients");
  container.innerHTML = "";

  snap.forEach(child => {
    const p = child.val();
    const id = child.key;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${p.name || "Unnamed"} (${id})</h3>
      <p>Age: ${p.age || "N/A"}</p>
      <p>Condition: ${p.condition || "-"}</p>
      <p>Risk: ${(p.riskScore || 0) * 100}%</p>
      <button class="btn-edit" onclick="editPatient('${id}')">‚úèÔ∏è Edit</button>
      <button class="btn-del" onclick="deletePatient('${id}')">üóë Delete</button>
      <button class="btn-add" onclick="openMap('${id}')">üìç Set Safe Center</button>
    `;

    container.appendChild(card);
  });
});

/* ---------------- ADD / UPDATE PATIENT ---------------- */
let editingId = null;

function openForm(id=null) {
  editingId = id;
  document.getElementById("formBox").classList.remove("hidden");

  if (!id) {
    document.getElementById("formTitle").innerText = "Add Patient";
    document.getElementById("pid").disabled = false;
    clearForm();
    return;
  }

  db.ref(`patients/${id}`).once("value", snap => {
    const p = snap.val();
    document.getElementById("formTitle").innerText = "Edit Patient";
    document.getElementById("pid").value = id;
    document.getElementById("pid").disabled = true;
    document.getElementById("pname").value = p.name || "";
    document.getElementById("page").value = p.age || "";
    document.getElementById("pcondition").value = p.condition || "";
  });
}

function savePatient() {
  const id = document.getElementById("pid").value.trim();
  if (!id) return alert("Patient ID required");

  const data = {
    name: pname.value,
    age: page.value,
    condition: pcondition.value,
    lastUpdated: Date.now()
  };

  db.ref(`patients/${id}`).update(data);
  closeForm();
}

function editPatient(id) { openForm(id); }

function deletePatient(id) {
  if (!confirm("Delete patient permanently?")) return;
  db.ref(`patients/${id}`).remove();
}

function closeForm() {
  document.getElementById("formBox").classList.add("hidden");
  clearForm();
}

function clearForm() {
  pid.value = pname.value = page.value = pcondition.value = "";
}

/* ---------------- SAFE CENTER MAP ---------------- */
let map, marker, selectedLatLng, mapPatientId;

function openMap(id) {
  mapPatientId = id;
  document.getElementById("mapBox").classList.remove("hidden");

  setTimeout(() => {
    map = L.map("map").setView([11.946, 75.351], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    map.on("click", e => {
      selectedLatLng = e.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);
    });
  }, 200);
}

function saveSafeCenter() {
  if (!selectedLatLng) return alert("Click on map to select location");

  db.ref(`patients/${mapPatientId}/safeCenter`).set({
    lat: selectedLatLng.lat,
    lon: selectedLatLng.lng
  });

  closeMap();
}

function closeMap() {
  document.getElementById("mapBox").classList.add("hidden");
  if (map) {
    map.remove();
    map = null;
    marker = null;
    selectedLatLng = null;
  }
}
</script>
<script>
const alertPanel = document.getElementById("alertPanel");
const alertList = document.getElementById("alertList");

firebase.database()
  .ref("alerts")
  .orderByChild("active")
  .equalTo(true)
  .on("value", snap => {

    alertList.innerHTML = "";

    if (!snap.exists()) {
      alertPanel.classList.add("hidden");
      return;
    }

    alertPanel.classList.remove("hidden");

    snap.forEach(child => {
      const alertId = child.key;
      const a = child.val();

      const div = document.createElement("div");
      div.className = "alert-item";

      div.innerHTML = `
        <h4>Patient: ${a.patientId}</h4>
        <p>Risk: ${(a.riskScore * 100).toFixed(1)}%</p>
        <p class="muted">
          ${new Date(a.timestamp).toLocaleTimeString()}
        </p>

        <div class="alert-actions">
          <button class="btn-ok"
            onclick="resolveAlert('${alertId}', '${a.patientId}', 'correct_alert')">
            ‚úÖ Correct
          </button>
          <button class="btn-bad"
            onclick="resolveAlert('${alertId}', '${a.patientId}', 'false_alarm')">
            ‚ùå False
          </button>
        </div>
      `;

      alertList.appendChild(div);
    });
  });

function resolveAlert(alertId, patientId, result) {
  const now = Date.now();

  // 1Ô∏è‚É£ Mark alert resolved
  firebase.database().ref(`alerts/${alertId}`).update({
    active: false,
    resolvedAt: now,
    resolution: result
  });

  // 2Ô∏è‚É£ Send feedback to ML
  firebase.database()
    .ref(`patients/${patientId}/lastFeedback`)
    .set(result);
}
</script>


</body>
</html>
