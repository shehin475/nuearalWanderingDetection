<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Caretaker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #38bdf8;
    }

    .card {
      background: #020617;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 0 10px rgba(56,189,248,0.15);
    }

    .patient-card {
      border-left: 6px solid #22c55e;
    }

    .warning {
      border-left-color: #facc15;
    }

    .alert {
      border-left-color: #ef4444;
    }

    .risk-bar {
      height: 10px;
      border-radius: 6px;
      background: #1e293b;
      overflow: hidden;
      margin: 6px 0 10px;
    }

    .risk-fill {
      height: 100%;
    }

    .risk-normal { background: #22c55e; }
    .risk-warning { background: #facc15; }
    .risk-alert { background: #ef4444; }

    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge.normal { background: #22c55e; }
    .badge.warning { background: #facc15; color:#020617; }
    .badge.alert { background: #ef4444; }

    .muted {
      color: #94a3b8;
      font-size: 13px;
    }

    button {
      padding: 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
      width: 100%;
    }

    .btn-ok { background: #22c55e; }
    .btn-bad { background: #ef4444; }
  </style>
</head>

<body>
<h1>üßë‚Äç‚öïÔ∏è Caretaker Dashboard</h1>
<div id="patients"></div>

<script>
  // üî¥ KEEP YOUR EXISTING FIREBASE CONFIG HERE
  const firebaseConfig = {
      apiKey: "AIzaSyAoR0vhcrxB3nw39ncqLJfmMET7ufokn1A",
      authDomain: "ai-wandering-system.firebaseapp.com",
      databaseURL: "https://ai-wandering-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ai-wandering-system",
      storageBucket: "ai-wandering-system.firebasestorage.app",
      messagingSenderId: "443603981661",
      appId: "1:443603981661:web:ce8ce7697cfbed2327c4b4",
      measurementId: "G-2Q49NF2RTB"
    };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function getRiskLevel(score) {
    if (score >= 70) return "alert";
    if (score >= 40) return "warning";
    return "normal";
  }

  function timeAgo(ts) {
    if (!ts) return "Unknown";
    const diff = Math.floor((Date.now() - ts) / 1000);
    if (diff < 60) return diff + " sec ago";
    if (diff < 3600) return Math.floor(diff / 60) + " min ago";
    return Math.floor(diff / 3600) + " hrs ago";
  }

  // ---------------- LOAD PATIENTS ----------------

  db.ref("patients").on("value", snapshot => {
    const container = document.getElementById("patients");
    container.innerHTML = "";

    if (!snapshot.exists()) {
      container.innerHTML = "<p>No patients found</p>";
      return;
    }

    const patients = [];

    snapshot.forEach(child => {
      const p = child.val();
      patients.push({ id: child.key, ...p });
    });

    // üî• Sort: alert ‚Üí warning ‚Üí normal
    patients.sort((a, b) => (b.riskScore || 0) - (a.riskScore || 0));

    patients.forEach(p => {
      const riskScore = p.riskScore || 0;
      const level = getRiskLevel(riskScore);
      const distance = p.distance ?? "N/A";
      const loc = p.currentLocation || {};

      const card = document.createElement("div");
      card.className = `card patient-card ${level}`;

      card.innerHTML = `
        <h3>${p.name || "Unnamed"} (${p.id})</h3>

        <span class="badge ${level}">
          ${level.toUpperCase()}
        </span>

        <div class="risk-bar">
          <div class="risk-fill risk-${level}"
               style="width:${riskScore}%"></div>
        </div>

        <p><b>Risk Score:</b> ${riskScore}</p>
        <p><b>Distance:</b> ${distance} m</p>

        <p class="muted">
          Last Update: ${timeAgo(p.lastUpdated)}
        </p>

        <p class="muted">
          Location:
          ${loc.lat ? `${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}` : "Unknown"}
        </p>

        <button class="btn-ok"
          onclick="submitFeedback('${p.id}', 'correct_alert')">
          ‚úÖ Alert Correct
        </button>

        <button class="btn-bad"
          onclick="submitFeedback('${p.id}', 'false_alarm')">
          ‚ùå False Alarm
        </button>
      `;

      container.appendChild(card);
    });
  });

  // ---------------- FEEDBACK ----------------

  function submitFeedback(patientId, type) {
    const id = "fb_" + Date.now();

    db.ref(`feedback/${patientId}/${id}`).set({
      type,
      timestamp: Date.now()
    });

    db.ref(`patients/${patientId}/lastFeedback`).set(type);

    alert("Feedback saved");
  }
</script>
</body>
</html>
